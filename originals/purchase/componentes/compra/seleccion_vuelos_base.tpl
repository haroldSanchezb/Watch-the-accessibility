<style type="text/css">
#contenido-proceso .tooltip_familia_SP ul, #contenido-proceso .tooltip_familia_LE ul, #contenido-proceso .tooltip_familia_FX ul,
#contenido-proceso .tooltip_familia_FF ul, #contenido-proceso .tooltip_familia_RY ul, #contenido-proceso .tooltip_familia_EJ ul {
	margin: 0 15px 0 25px;
	padding: 0;
	list-style-position: inherit;
}
.tooltip_familia_SP {
	position: absolute;
	width: 164px;
	margin-top: -10px;
	margin-left: -160px;
	/*border: solid 1px #cccccc;*/
}
	
* html .tooltip_familia_SP {
	position: absolute;
	width: 164px;
	margin-top: -10px;
	margin-left: -160px;
	/*border: solid 1px #cccccc;*/
}
	
.tooltip_familia_SP .top {
	background: url(/images/compra/top_sp.png) center bottom no-repeat;
	width: 164px;
	height: 12px;
}

* html .tooltip_familia_SP .top {
	background: url(/images/compra/top_sp.gif) center bottom no-repeat;
}

.tooltip_familia_SP .middle {
	background: url(/images/compra/bg_sp.png) center repeat-y;
	width: 164px;
}

* html .tooltip_familia_SP .middle {
	background: url(/images/compra/bg_sp.gif) center repeat-y;
}

.tooltip_familia_SP .bottom {
	background: url(/images/compra/bottom_sp.png) center top no-repeat;
	width: 164px;
	height: 16px;
}

* html .tooltip_familia_SP .bottom {
	background: url(/images/compra/bottom_sp.gif) center top no-repeat;
}

.tooltip_familia_SP ul {
	margin-left: 25px;
	margin-right: 15px;
	font-size: 1.5em;
	text-align: left;
	margin-top: 0;
	margin-bottom: 0;
	background-color: #ffffff;
}

* html .tooltip_familia_SP ul {
	margin-left: 25px;
	margin-right: 15px;
	font-size: 1.5em;
	text-align: left;
	margin-top: 0;
	margin-bottom: 0;
	background-color: #ffffff;
}

.tooltip_familia_SP li {
	color: {_FF_BG_COLOR_TITLE_SP};
	padding-bottom: 7px;
}

* html .tooltip_familia_SP li {
	color: {_FF_BG_COLOR_TITLE_SP};
	padding-bottom: 7px;
}

.tooltip_familia_SP p {
	color: black;
	font-size: 0.6em;
	margin: 0;
}

* html .tooltip_familia_SP p {
	color: black;
	font-size: 0.6em;
	margin: 0;
}
	
.tooltip_familia_LE {
	position: absolute;
	width: 164px;
	margin-top: -10px;
	margin-left: -160px;
	/*border: solid 1px #cccccc;*/
}

* html .tooltip_familia_LE {
	position: absolute;
	width: 164px;
	margin-top: -10px;
	margin-left: -160px;
	/*border: solid 1px #cccccc;*/
}

.tooltip_familia_LE .top {
	background: url(/images/compra/top_le.png) center bottom no-repeat;
	width: 164px;
	height: 12px;
}
	
* html .tooltip_familia_LE .top {
	background: url(/images/compra/top_le.gif) center bottom no-repeat;
}

.tooltip_familia_LE .middle {
	background: url(/images/compra/bg_le.png) center repeat-y;
	width: 164px;
}

* html .tooltip_familia_LE .middle {
	background: url(/images/compra/bg_le.gif) center repeat-y;
}

.tooltip_familia_LE .bottom {
	background: url(/images/compra/bottom_le.png) center top no-repeat;
	width: 164px;
	height: 16px;
}

* html .tooltip_familia_LE .bottom {
	background: url(/images/compra/bottom_le.gif) center top no-repeat;
}

.tooltip_familia_LE ul {
	margin-left: 25px;
	margin-right: 15px;
	font-size: 1.5em;
	text-align: left;
	margin-top: 0;
	margin-bottom: 0;
	background-color: #ffffff;
}

* html .tooltip_familia_LE ul {
	margin-left: 25px;
	margin-right: 15px;
	font-size: 1.5em;
	text-align: left;
	margin-top: 0;
	margin-bottom: 0;
	background-color: #ffffff;
}

.tooltip_familia_LE li {
	color: {_FF_BG_COLOR_TITLE_LE};
	padding-bottom: 7px;
}

* html .tooltip_familia_LE li {
	color: {_FF_BG_COLOR_TITLE_LE};
	padding-bottom: 7px;
}

.tooltip_familia_LE p {
	color: black;
	font-size: 0.6em;
	margin: 0;
}

* html .tooltip_familia_LE p {
	color: black;
	font-size: 0.6em;
	margin: 0;
}

.tooltip_familia_FX {
	position: absolute;
	width: 164px;
	margin-top: -10px;
	margin-left: -160px;
	/*border: solid 1px #cccccc;*/
}

* html .tooltip_familia_FX {
	position: absolute;
	width: 164px;
	margin-top: -10px;
	margin-left: -160px;
	/*border: solid 1px #cccccc;*/
}

.tooltip_familia_FX .top {
	background: url(/images/compra/top_fx.png) center bottom no-repeat;
	width: 164px;
	height: 12px;
}

* html .tooltip_familia_FX .top {
	background: url(/images/compra/top_fx.gif) center bottom no-repeat;
}

.tooltip_familia_FX .middle {
	background: url(/images/compra/bg_fx.png) center repeat-y;
	width: 164px;
}

* html .tooltip_familia_FX .middle {
	background: url(/images/compra/bg_fx.gif) center repeat-y;
}

.tooltip_familia_FX .bottom {
	background: url(/images/compra/bottom_fx.png) center top no-repeat;
	width: 164px;
	height: 16px;
}

* html .tooltip_familia_FX .bottom {
	background: url(/images/compra/bottom_fx.gif) center top no-repeat;
}

.tooltip_familia_FX ul {
	margin-left: 25px;
	margin-right: 15px;
	font-size: 1.5em;
	text-align: left;
	margin-top: 0;
	margin-bottom: 0;
	background-color: #ffffff;
}

* html .tooltip_familia_FX ul {
	margin-left: 25px;
	margin-right: 15px;
	font-size: 1.5em;
	text-align: left;
	margin-top: 0;
	margin-bottom: 0;
	background-color: #ffffff;
}

.tooltip_familia_FX li {
	color: {_FF_BG_COLOR_TITLE_FX};
	padding-bottom: 7px;
}

* html .tooltip_familia_FX li {
	color: {_FF_BG_COLOR_TITLE_FX};
	padding-bottom: 7px;
}

.tooltip_familia_FX p {
	color: black;
	font-size: 0.6em;
	margin: 0;
}

* html .tooltip_familia_FX p {
	color: black;
	font-size: 0.6em;
	margin: 0;
}

.tooltip_familia_FF {
	position: absolute;
	width: 164px;
	margin-top: -10px;
	margin-left: -160px;
	/*border: solid 1px #cccccc;*/
}

* html .tooltip_familia_FF {
	position: absolute;
	width: 164px;
	margin-top: -10px;
	margin-left: -160px;
	/*border: solid 1px #cccccc;*/
}

.tooltip_familia_FF .top {
	background: url(/images/compra/top_ff.png) center bottom no-repeat;
	width: 164px;
	height: 12px;
}

* html .tooltip_familia_FF .top {
	background: url(/images/compra/top_ff.gif) center bottom no-repeat;
}

.tooltip_familia_FF .middle {
	background: url(/images/compra/bg_ff.png) center repeat-y;
	width: 164px;
}

* html .tooltip_familia_FF .middle {
	background: url(/images/compra/bg_ff.gif) center repeat-y;
}

.tooltip_familia_FF .bottom {
	background: url(/images/compra/bottom_ff.png) center top no-repeat;
	width: 164px;
	height: 16px;
}

* html .tooltip_familia_FF .bottom {
	background: url(/images/compra/bottom_ff.gif) center top no-repeat;
}

.tooltip_familia_FF ul {
	margin-left: 25px;
	margin-right: 15px;
	font-size: 1.5em;
	text-align: left;
	margin-top: 0;
	margin-bottom: 0;
	background-color: #ffffff;
}

* html .tooltip_familia_FF ul {
	margin-left: 25px;
	margin-right: 15px;
	font-size: 1.5em;
	text-align: left;
	margin-top: 0;
	margin-bottom: 0;
	background-color: #ffffff;
}

.tooltip_familia_FF li {
	color: {_FF_BG_COLOR_TITLE_FF};
	padding-bottom: 7px;
}

* html .tooltip_familia_FF li {
	color: {_FF_BG_COLOR_TITLE_FF};
	padding-bottom: 7px;
}

.tooltip_familia_FF p {
	color: black;
	font-size: 0.6em;
	margin: 0;
}

* html .tooltip_familia_FF p {
	color: black;
	font-size: 0.6em;
	margin: 0;
}

.tooltip_familia_RY {
	position: absolute;
	width: 164px;
	margin-top: -10px;
	margin-left: -160px;
	/*border: solid 1px #cccccc;*/
}

* html .tooltip_familia_RY {
	position: absolute;
	width: 164px;
	margin-top: -10px;
	margin-left: -160px;
	/*border: solid 1px #cccccc;*/
}

.tooltip_familia_RY .top {
	background: url(/images/compra/top_ry.png) center bottom no-repeat;
	width: 164px;
	height: 12px;
}

* html .tooltip_familia_RY .top {
	background: url(/images/compra/top_ry.gif) center bottom no-repeat;
}

.tooltip_familia_RY .middle {
	background: url(/images/compra/bg_ry.png) center repeat-y;
	width: 164px;
}

* html .tooltip_familia_RY .middle {
	background: url(/images/compra/bg_ry.gif) center repeat-y;
}

.tooltip_familia_RY .bottom {
	background: url(/images/compra/bottom_ry.png) center top no-repeat;
	width: 164px;
	height: 16px;
}

* html .tooltip_familia_RY .bottom {
	background: url(/images/compra/bottom_ry.gif) center top no-repeat;
}

.tooltip_familia_RY ul {
	margin-left: 25px;
	margin-right: 15px;
	font-size: 1.5em;
	text-align: left;
	margin-top: 0;
	margin-bottom: 0;
	background-color: #ffffff;
}

* html .tooltip_familia_RY ul {
	margin-left: 25px;
	margin-right: 15px;
	font-size: 1.5em;
	text-align: left;
	margin-top: 0;
	margin-bottom: 0;
	background-color: #ffffff;
}

.tooltip_familia_RY li {
	color: {_FF_BG_COLOR_TITLE_RY};
	padding-bottom: 7px;
}

* html .tooltip_familia_RY li {
	color: {_FF_BG_COLOR_TITLE_RY};
	padding-bottom: 7px;
}

.tooltip_familia_RY p {
	color: black;
	font-size: 0.6em;
	margin: 0;
}

* html .tooltip_familia_RY p {
	color: black;
	font-size: 0.6em;
	margin: 0;
}

.tooltip_familia_EJ {
	position: absolute;
	width: 164px;
	margin-top: -10px;
	margin-left: -160px;
	/*border: solid 1px #cccccc;*/
}

* html .tooltip_familia_EJ {
	position: absolute;
	width: 164px;
	margin-top: -10px;
	margin-left: -160px;
	/*border: solid 1px #cccccc;*/
}

.tooltip_familia_EJ .top {
	background: url(/images/compra/top_ej.png) center bottom no-repeat;
	width: 164px;
	height: 12px;
}

* html .tooltip_familia_EJ .top {
	background: url(/images/compra/top_ej.gif) center bottom no-repeat;
}

.tooltip_familia_EJ .middle {
	background: url(/images/compra/bg_ej.png) center repeat-y;
	width: 164px;
}

* html .tooltip_familia_EJ .middle {
	background: url(/images/compra/bg_ej.gif) center repeat-y;
}

.tooltip_familia_EJ .bottom {
	background: url(/images/compra/bottom_ej.png) center top no-repeat;
	width: 164px;
	height: 16px;
}

* html .tooltip_familia_EJ .bottom {
	background: url(/images/compra/bottom_ej.gif) center top no-repeat;
}

.tooltip_familia_EJ ul {
	margin-left: 25px;
	margin-right: 15px;
	font-size: 1.5em;
	text-align: left;
	margin-top: 0;
	margin-bottom: 0;
	background-color: #ffffff;
}

* html .tooltip_familia_EJ ul {
	margin-left: 25px;
	margin-right: 15px;
	font-size: 1.5em;
	text-align: left;
	margin-top: 0;
	margin-bottom: 0;
	background-color: #ffffff;
}

.tooltip_familia_EJ li {
	color: {_FF_BG_COLOR_TITLE_EJ};
	padding-bottom: 7px;
}

* html .tooltip_familia_EJ li {
	color: {_FF_BG_COLOR_TITLE_EJ};
	padding-bottom: 7px;
}

.tooltip_familia_EJ p {
	color: black;
	font-size: 0.6em;
	margin: 0;
}

* html .tooltip_familia_EJ p {
	color: black;
	font-size: 0.6em;
	margin: 0;
}

</style>

		<!-- El tooltip para las familias -->
		
<script type="text/javascript">

	jQuery.noConflict();

	var divName = 'following_tooltip'; // div that is to follow the mouse
	var offX = 15;         // X offset from mouse position
	var offY = 25;         // Y offset from mouse position
	var impuestos_ida, impuestos_vuelta;
	var total_fee = 0;
	var total_q = 0;

	//---

	var colores_ff = Array();
	var tarifa = 0;
	var tarifa_pagada = document.getElementById("tarifa_pagada");
	var multa = '{MULTA}';
	var tarifa_segmento = new Array();
	var segmentos_vuelos = new Array();
	var familia = new Hash();
	var radio_selected = new Array();
	var combina_con = new Array();
	var segmento_restringido = 0;
	
	//--
	
	var cache_regulaciones = new Array();

	//--

	var regulaciones_on = new Array('false', 'false', 'false');

	//--

	// Preload del fondo del ttip para Click
	var img_top = new Image();
	var img_mid = new Image();
	var img_bot = new Image();

	var version = parseFloat(navigator.appVersion.split('MSIE')[1]);
	if ((version >=5.5) && (version < 7))
		{
		img_top.src = '/images/compra/top_ck.gif';
		img_mid.src = '/images/compra/bg_ck.gif';
		img_bot.src = '/images/compra/bottom_ck.gif';
		}
	else
		{
		img_top.src = '/images/compra/top_ck.png';
		img_mid.src = '/images/compra/bg_ck.png';
		img_bot.src = '/images/compra/bottom_ck.png';
		}


function init_owflex()
	{
	
	var desde_paso3 = document.getElementById("mowflex_desde_paso3");

	if ( desde_paso3.value == '0')
		{
		return;
		}

	var familia1 = '{FAMILIA_1}';
	var vuelo1 = '{VUELO_1}';
	var familia2 = '{FAMILIA_2}';
	var vuelo2 = '{VUELO_2}';
	var celda_ida = document.getElementById('tdfamilia' + familia1 + '[1][' + vuelo1 + ']');

	celda_ida.onclick();
	
	if(familia2 != '')
		{
		var celda_vuelta = document.getElementById('tdfamilia' + familia2 + '[2][' + vuelo2 + ']');
		celda_vuelta.onclick();
		}

	}

function init_segmentos(id_segmento)
	{
	tarifa_segmento[id_segmento] = '';
	segmentos_vuelos[id_segmento] = new Array();
	}

function cambiar_dia(id_segmento, fecha, link)
	{
	// Revisar que nuevo dia este en la matriz
	var fecha_ida_min = document.getElementById('fecha_ida_min').value;
	var fecha_ida_max = document.getElementById('fecha_ida_max').value;
	var fecha_vuelta_min = document.getElementById('fecha_vuelta_min').value;
	var fecha_vuelta_max = document.getElementById('fecha_vuelta_max').value;
	var fecha_seleccionada = document.getElementById('fechas_owflex_cargado').value;
	var fechas_separadas = fecha_seleccionada.split('_');
	var fecha_nueva = fecha;
	
	fecha_ida_min = (fecha_ida_min.split("-")).join("");
	fecha_ida_max = (fecha_ida_max.split("-")).join("");
	fecha_vuelta_min = (fecha_vuelta_min.split("-")).join("");
	fecha_vuelta_max = (fecha_vuelta_max.split("-")).join("");
	
	fecha = (fecha.split("-")).join("");

	if (id_segmento == 1 && fecha >= fecha_ida_min && fecha <= fecha_ida_max)
		{
		despliega_owflex(fecha_nueva, fechas_separadas[1]);
		}
	else if(id_segmento == 2 && fecha >= fecha_vuelta_min && fecha <= fecha_vuelta_max)
		{
		despliega_owflex(fechas_separadas[0], fecha_nueva);
		}
	else
		{
		if (id_segmento == 1 && fecha_nueva > fechas_separadas[1] || id_segmento == 2 && fecha_nueva < fechas_separadas[0])
			{
			alert("{_MSG_ERROR_MOWFLEX_FECHA_NO_DISPO_JS}");
			return false;
			}
		//Recarga paso cuando la fecha a cambiar no esta en la matriz
		window.location = link + "&flex=1";
		}
	}

function cambiar_estilo(celda, id_segmento)
	{

	var nuevo_color = "#000000";
	var nuevo_bgcolor = "#FDE966";

	var celda_owflex_anterior = document.getElementById("celda_owflex_anterior_" + id_segmento);
	var estilo_celda_owflex_anterior = document.getElementById("estilo_celda_owflex_anterior_" + id_segmento);

	
	if(celda_owflex_anterior.value != '')
		{
		var celda_anterior = document.getElementById(celda_owflex_anterior.value);
		var estilo_anterior  =  estilo_celda_owflex_anterior.value.split('|');
		var color = '';
		var bg_color = '';

		color = estilo_anterior[0];
		bg_color = estilo_anterior[1];

		celda_anterior.style.color = color;
		celda_anterior.style.backgroundColor = bg_color;
		}

	celda_owflex_anterior.value = celda.id;
	estilo_celda_owflex_anterior.value = document.getElementById("estilo_celda_owflex_mouseover").value;
	celda.style.color = nuevo_color;
	celda.style.backgroundColor = nuevo_bgcolor;
	}


function get_selected_id_from_radio(f, name)
	{
	var radioObj = f[name];
	if(!radioObj)
		{
		return;
		}
	var radioLength = radioObj.length;
	if(radioLength == undefined)
		{
		if(radioObj.checked)
			{
			radioObj.click();
			return;
			}
		else
			{
			return;
			}
		}
	for(var i = 0; i < radioLength; i++)
		{
		if(radioObj[i].checked)
			{
			radioObj[i].click();
			return;
			}
		}
	return;
	}

function limpiar_combinaciones ()
	{
	var precio_final='{PRECIO_FINAL}';
	var is_rowflex = '{ROWFLEX}';
	total_fee=0;
	total_q = 0;
	familia.each(function(pair)
		{
		if (typeof(pair.value) == "function")
			{
			return;
			}

		var family = pair.key;
		for (var i=1; i < segmentos_vuelos.length; i++)
			{
			if (segmentos_vuelos[i]) 
				{
				for (var j = 1; j < segmentos_vuelos[i].length; j++)
					{
					if (!$('tdfamilia' + family + '[' + i + '][' + j + ']'))
						{	
					continue;
						}
						
					if ($('tdfamilia' + family + '[' + i + '][' + j + ']').ffColor)
						{
						$('tdfamilia' + family + '[' + i + '][' + j + ']').style.backgroundColor = $('tdfamilia' + family + '[' + i + '][' + j + ']').ffColor;
						$('tdfamilia' + family + '[' + i + '][' + j + ']').style.color = $('tdfamilia' + family + '[' + i + '][' + j + ']').fgColor;
						}

					var radio = $('radiofamilia' + family + '[' + i + '][' + j + ']');
					if (radio)
						{
						if (radio.checked)
							{
							tarifa_segmento[i] = $('valor_tarifa_seg' + i + '_vue' + j + '_fam' + family).value;
							
							if (precio_final)
								{
								var taxes_tarifa_segmento = $('taxes_tarifa_seg' + i + '_vue' + j + '_fam' + family).value;
								
								if(i == 1)	
									{
									impuestos_ida = eval(taxes_tarifa_segmento);								
									}
								else
									{
									impuestos_vuelta = eval(taxes_tarifa_segmento);								
									}
								}
								if (is_rowflex) {
									total_fee += parseFloat($('fee_tarifa_seg' + i + '_vue' + j + '_fam' + family).value);
									if ($('q_tarifa_seg' + i + '_vue' + j + '_fam' + family).value) {
										total_q += parseFloat($('q_tarifa_seg' + i + '_vue' + j + '_fam' + family).value);
									}
								}
							}
						}
					}
				}
			}
		})
	}

function restringe_vuelos(f, segmento, vuelo, clase, id_familia, moneda, valor_tarifa)
	{
	var kms_disponibles = '{MAX_KMS}';
	var segmento_opuesto = (segmento == 1 ? 2 : 1);
	var colordisabled = document.getElementById('disabledcolor').style.backgroundColor;
	var restringido = 0;
	var opuesto_seleccionado = 0;
	if (document.getElementById('tdfamilia' + id_familia + '[' + segmento + '][' + vuelo + ']').style.backgroundColor == colordisabled)
		{
		restringido = 1;
		}
	for (i = 1; i < segmentos_vuelos[segmento_opuesto].length; i++)
		{
		if (document.getElementById('tdfamilia' + id_familia + '[' + segmento_opuesto + '][' + i + ']').style.backgroundColor != colordisabled)
			{
			break;
			}
		}
	if (i == segmentos_vuelos[segmento_opuesto].length)
		{
		restringido = 1;
		}
	
	
	if ((segmento_restringido != segmento) || restringido == 1)
		{
		limpiar_combinaciones();	
		var max_tarifa_opuesto = 0;
		
		for (i = 1; i < segmentos_vuelos[segmento_opuesto].length; i++)
			{
			var obj = $('valor_tarifa_seg' + segmento_opuesto + '_vue' + i + '_fam' + id_familia);
			
			if (!obj)
				{
				continue;
				}
			var tarifa = obj.value;	
			segmento_restringido = segmento_opuesto;
			if ((kms_disponibles - valor_tarifa) < tarifa)
				{
				// Respaldo colores
				$('tdfamilia' + id_familia + '[' + segmento_opuesto + '][' + i + ']').ffColor = $('tdfamilia' + id_familia + '[' + segmento_opuesto + '][' + i + ']').style.backgroundColor;
				$('tdfamilia' + id_familia + '[' + segmento_opuesto + '][' + i + ']').fgColor = $('tdfamilia' + id_familia + '[' + segmento_opuesto + '][' + i + ']').style.color;
				
				// Aplico color desactivado
				$('tdfamilia' + id_familia + '[' + segmento_opuesto + '][' + i + ']').style.backgroundColor = colordisabled;
				$('tdfamilia' + id_familia + '[' + segmento_opuesto + '][' + i + ']').style.color = '#AAAAAA';

				if ($('radiofamilia' + id_familia + '[' + segmento_opuesto + '][' + i + ']'))
					{
					if ($('radiofamilia' + id_familia + '[' + segmento_opuesto + '][' + i + ']').checked == true)
						{
						$('radiofamilia' + id_familia + '[' + segmento_opuesto + '][' + i + ']').checked = false;
						f.elements['vuelo_segmento' + segmento_opuesto].value = '';
						f.elements['clase_segmento' + segmento_opuesto].value = '';
						tarifa_segmento[segmento_opuesto] = '';
						}
					}
				
				}
			}
		}
	}

function set_vuelo_y_clase (f, segmento, vuelo, clase, id_familia, moneda, valor_tarifa, farebasis, nombre, impuestos)
	{
	var precio_final='{PRECIO_FINAL}';
	var is_rowflex = '{ROWFLEX}';
	var colordisabled = document.getElementById('disabledcolor').style.backgroundColor;
	var limpia = 1;
	
		
	if (document.getElementById('tdfamilia' + id_familia + '[' + segmento + '][' + vuelo + ']').style.backgroundColor == colordisabled)
		{
		if (!confirm ("{_MSG_CONFIRM_CAMBIO_FAMILIA_PASO2_JS}"))
			{
			if (radio_selected[segmento])
				{
				radio_selected[segmento].checked = true;
				}
			else
				{
				document.getElementById('radiofamilia' + id_familia + '[' + segmento + '][' + vuelo + ']').checked = false;
				}
			return 0;
			}
		}

	radio_selected[segmento] = document.getElementById('radiofamilia' + id_familia + '[' + segmento + '][' + vuelo + ']');
	if (radio_selected[segmento] &&
		!radio_selected[segmento].checked)
		{
		radio_selected[segmento].checked = true;
		}
	if ('{FLAVOUR}' == 'cambio_fecha_cplp_variable')
		{
		restringe_vuelos(f, segmento, vuelo, clase, id_familia, moneda, valor_tarifa);
		limpia = 0;
		}
	
	if (limpia == 1)
		{
		limpiar_combinaciones();
		}
	
	familia.each(function(pair)
		{
		if (typeof(pair.value) == "function") 
			{
			return;
			}
			
		var family = pair.key;
		for (var i=1; i < segmentos_vuelos.length; i++)
			{
			for (var j = 1; j < segmentos_vuelos[i].length; j++)
				{
				var f1;
				var f2;
				if (segmento == 1)
					{
					f1 = id_familia;
					f2 = family;
					}
				else if (segmento == 2)
					{
					f2 = id_familia;
					f1 = family;
					}
				if (!combina_con[f1][f2])
					{
					if (!$('tdfamilia' + family + '[' + i + '][' + j + ']'))
						{	
						continue;
						}
					
					// Respaldo colores
					$('tdfamilia' + family + '[' + i + '][' + j + ']').ffColor = $('tdfamilia' + family + '[' + i + '][' + j + ']').style.backgroundColor;
					$('tdfamilia' + family + '[' + i + '][' + j + ']').fgColor = $('tdfamilia' + family + '[' + i + '][' + j + ']').style.color;
					
					// Aplico color desactivado
					$('tdfamilia' + family + '[' + i + '][' + j + ']').style.backgroundColor = colordisabled;
					$('tdfamilia' + family + '[' + i + '][' + j + ']').style.color = '#AAAAAA';

					if ($('radiofamilia' + family + '[' + i + '][' + j + ']'))
						{
						if ($('radiofamilia' + family + '[' + i + '][' + j + ']').checked == true)
							{
							$('radiofamilia' + family + '[' + i + '][' + j + ']').checked = false;
							f.elements['vuelo_segmento' + i].value = '';
							f.elements['clase_segmento' + i].value = '';
							tarifa_segmento[i] = '';
							}
						}
					}
				}
			}
		});

	$("clase_segmento" + segmento).value = clase;
	$("vuelo_segmento" + segmento).value = vuelo;
	
	$("familia_segmento" + segmento).value = id_familia;
	$("currency_segmento" + segmento).value = moneda;
	$("monto_segmento" + segmento).value = valor_tarifa;

	if(nombre == "vueloida")
		{
		$("farebasis_segmento_ida").value = farebasis;
		impuestos_ida = impuestos;
		$("precio_final_paso2_ida").value = currency_round_fare(valor_tarifa, '{ID_MONEDA}');
		}
	else
		{
		$("farebasis_segmento_vuelta").value = farebasis;
		impuestos_vuelta = impuestos;	
		$("precio_final_paso2_vuelta").value = currency_round_fare(valor_tarifa,'{ID_MONEDA}');
		}
	tarifa_segmento[segmento] = valor_tarifa;
	calcula_tarifa();
	}

function calcula_tarifa ()
	{
	var precio_final='{PRECIO_FINAL}';
	var is_rowflex = '{ROWFLEX}';
	if (!$('sumatarifas'))
		{
		return;
		}
	
	var tarifa = 0;
	var precio_total;
	var impuestos = 0;
	
	for (var i = 1; i < tarifa_segmento.length; i++)
		{
		if (tarifa_segmento[i] != '')
			{
			tarifa = tarifa + parseFloat(tarifa_segmento[i]);
			}
		else
			{
			tarifa = '';
			break;
			}
		}

	if ($('sumatarifas_real'))
		{
		if (multa)
			{
			$('sumatarifas_real').value = tarifa + parseFloat(multa);
			}
		else
			{
			$('sumatarifas_real').value = tarifa;
			}
			
		//alert ("Suma tarifas real: " + $('sumatarifas_real').value);
		}

	if (tarifa != '' || (typeof(tarifa) == 'number' && tarifa == 0))
		{
		if (tarifa < 0)
			{
			tarifa = 0;
			}
		if ('{FLAVOUR}' == 'cplp_variable' || '{FLAVOUR}' == 'cambio_fecha_cplp_variable')
			{
			$('sumatarifas').innerHTML = currency_format(tarifa, 'CLP') + '{SIGNO_MONEDA}';
			}
		else if (precio_final == 1 || is_rowflex == 1)
			{
			//aqui calcular los impuestos para mostrar luego el total
			precio_total = parseFloat(currency_round_fare(tarifa, '{ID_MONEDA}'));
			var total_impuestos = get_total_impuestos(precio_total);
			var precio_final = precio_total + total_impuestos;	
		
			$('precio_final_paso2').value = precio_total;
			
			if (is_rowflex == 1) {
				precio_total -= total_q;
			}
		
			var precio_total_raw = precio_total;
			precio_total = currency_format(precio_total, '{ID_MONEDA}');
			
			$('tarifa_sin_impuesto').innerHTML = '{SIGNO_MONEDA}' + precio_total + ' {_LABEL_POR_PASAJERO}';
			
			$('taxes_final_paso2').value = total_impuestos;
			total_impuestos = currency_format(total_impuestos, '{ID_MONEDA}');
			$('total_impuestos').innerHTML = '{SIGNO_MONEDA}' + total_impuestos + ' {_LABEL_POR_PASAJERO}';

			if (is_rowflex == 1 || 'COP' == '{ID_MONEDA}') {
				if (jQuery.data(document.body, 'feeChargeData') !== null && jQuery.data(document.body, 'feeChargeData').tipo_config !== 'normal') {
					total_fee = getFee(precio_total_raw, total_q, '{ID_MONEDA}');
				}
				$('total_q').innerHTML = '{SIGNO_MONEDA}' + currency_format(total_q, '{ID_MONEDA}') + ' {_LABEL_POR_PASAJERO}';
				$('total_fee').innerHTML = '{SIGNO_MONEDA}' + currency_format(total_fee, '{ID_MONEDA}') + ' {_LABEL_POR_PASAJERO}';
				precio_final += total_fee;
			}
		
			if (eval($('q_desplegado_paso2'))) {
	       		$('q_desplegado_paso2').value = total_q;
			}		
			
			
			precio_final = currency_format(precio_final, '{ID_MONEDA}');
		
			$('sumatarifas').innerHTML = '{SIGNO_MONEDA}' + precio_final + ' {_LABEL_POR_PASAJERO}';

			}
		else
			{
			precio_total = currency_format(Math.round(tarifa), '{ID_MONEDA}');
			$('precio_final_paso2').value = Math.round(tarifa);
		     	
			$('sumatarifas').innerHTML = '{SIGNO_MONEDA}' + precio_total + ' {_LABEL_POR_PASAJERO}';
			}
	
		}
	else
		{
		$('sumatarifas').innerHTML = '';
		}
	}
	
function get_total_impuestos(tarifa)
	{
	var monto_total_impuestos = 0;
	var monto_total_porcentajes = 0;
	var doble_impuesto = 0;
	var tarifa_ida = parseFloat($("precio_final_paso2_ida").value);
	var tarifa_vuelta = $("precio_final_paso2_vuelta").value != "" ? parseFloat($("precio_final_paso2_vuelta").value) : 0;
	var d;
	var impuestos_cobrados_ida = new Hash({});
	var impuestos_cobrados_vuelta = new Hash({});
	
	if(impuestos_ida && typeof(impuestos_ida) != "number")	
		{
		for (var i = 0;i<impuestos_ida.length;i++)
			{
			var h = impuestos_ida[i];
			h.each(function(p) {
				d = p.value;
				if (d['monto'] > 0)
					{
					monto_total_impuestos += d['monto'];
					}
				else if (d['porcentaje'] > 0)
					{
					if (!impuesto_aplicado(p.key, impuestos_cobrados_ida))
						{
						if (d['aplicacion'] == 'FARE')
							{
							var tarifaIdaYVuelta = tarifa_ida + tarifa_vuelta;
							monto_parcial_porcentajes = tarifaIdaYVuelta * d['porcentaje']/100;
							monto_total_porcentajes += parseFloat(currency_round_tax(monto_parcial_porcentajes, '{ID_MONEDA}', p.key));
							}
						else
							{
							monto_total_porcentajes += calcula_monto_especial(p.key, d['porcentaje'], d['aplicacion'], tarifa_ida, impuestos_ida);
							}
						impuestos_cobrados_ida[p.key] = '1';
						}
					}
				});
			}
		}

	if (impuestos_vuelta && typeof(impuestos_vuelta) != "number")
		{
		for (var i = 0;i<impuestos_vuelta.length;i++)
			{
			var h = impuestos_vuelta[i];
			h.each(function(p) {
				d = p.value;
				if (d['monto'] > 0)
					{
					monto_total_impuestos += d['monto'];
					}
				else if (d['porcentaje'] > 0)
					{
					if (!impuesto_aplicado(p.key, impuestos_cobrados_vuelta))
						{
						if (d['aplicacion'] == 'FARE')
							{
							var tarifaIdaYVuelta = tarifa_ida + tarifa_vuelta;
							monto_parcial_porcentajes = tarifaIdaYVuelta * d['porcentaje']/100;
							monto_total_porcentajes += parseFloat(currency_round_tax(monto_parcial_porcentajes, '{ID_MONEDA}', p.key));
							}
						else
							{
							monto_total_porcentajes += calcula_monto_especial(p.key, d['porcentaje'], d['aplicacion'], tarifa_vuelta, impuestos_ida);
							}
						impuestos_cobrados_vuelta[p.key] = '1';
						}
					}
				});
			}
		}


	return (monto_total_impuestos + monto_total_porcentajes);
	} 

function owflex_mouseout(celda, id_segmento)
	{
       var celda_seleccionada = document.getElementById('celda_owflex_anterior_'+ id_segmento).value;
       if (celda.id == celda_seleccionada)
               {
               return;
               }

       var celda_owflex = document.getElementById("celda_owflex_mouseover");
       var estilo_celda_owflex = document.getElementById("estilo_celda_owflex_mouseover");
       if(celda_owflex.value != '')
               {
               var estilo_anterior  =  estilo_celda_owflex.value.split('|');
               var color = '';
               var bg_color = '';
               color = estilo_anterior[0];
               bg_color = estilo_anterior[1]; 
               celda.style.color = color;
               celda.style.backgroundColor = bg_color;
               }

       }

function owflex_mouseover(celda, id_segmento)
       {
       var celda_seleccionada = document.getElementById('celda_owflex_anterior_'+ id_segmento).value;
       if (celda.id == celda_seleccionada)
               {
               return;
               }

       var nuevo_color = "#FFFFFF";
       var nuevo_bgcolor = "#033D7D";
       var celda_owflex = document.getElementById("celda_owflex_mouseover");
       var estilo_celda_owflex = document.getElementById("estilo_celda_owflex_mouseover");
       celda_owflex.value = celda.id;
	   estilo_celda_owflex.value = celda.style.color +  '|' + celda.style.backgroundColor;
       celda.style.color = nuevo_color;
       celda.style.backgroundColor = nuevo_bgcolor;
}



function impuesto_aplicado (tax, impuestos_cobrados)
	{
	var cobrado = 0;
	impuestos_cobrados.each(function(p){
		if (p.key == tax)
			{
			cobrado = 1;
			}
		});
	return cobrado;
	}

function calcula_monto_especial(tax, porcentaje, aplica_sobre, tarifa, impuestos_ref)
	{
	var tax_code;
	var detalle;
	var fare = 'FARE';

	var match_fare = fare.match(aplica_sobre);
	var match_code;

	var result = 0;

	if (match_fare != null)
		{
		result += currency_round_tax(tarifa * porcentaje/100, '{ID_MONEDA}', tax_code);
		result = parseFloat(result);
		}

	for (var i=0;i<impuestos_ref.length;i++)
		{
		impuestos = impuestos_ref[i];
		impuestos.each(function(p){
			tax_code = p.key;
			detalle = p.value;
			match_code = tax_code.match(aplica_sobre);
			if (tax != tax_code && match_code != null)
				{
				if (detalle['monto'] > 0)
					{
					result += parseFloat(currency_round_tax(detalle['monto'] * porcentaje/100, '{ID_MONEDA}', tax_code));
					}
				else if (detalle['porcentaje'] > 0)
					{
					var temp_result = tarifa * detalle['porcentaje']/100;
					temp_result = currency_round_tax(temp_result, '{ID_MONEDA}', tax_code);
					temp_result = parseFloat(temp_result);
					result += temp_result * porcentaje/100;
					}
				}
			});
		}

	return result
	}

function get_regulaciones(src, seg)
	{
	document.body.style.cursor = 'wait';
	new Effect.Appear('indicator' + seg);
	if (cache_regulaciones[src])
		{
		$('layer_regulaciones_content' + seg).innerHTML = cache_regulaciones[src];
		show_regulaciones('', seg);
		return;
		}
	else
		{
		new Ajax.Updater('layer_regulaciones_content' + seg, src, {method:'get', onSuccess: function(){show_regulaciones(src, seg)}});
		}
	}

function show_regulaciones(src, seg)
	{
	//$('layer_regulaciones_content').innerHTML = $('contenido');
	new Effect.Fade('indicator' + seg);
	new Effect.SlideDown('layer_regulaciones' + seg);
	document.body.style.cursor = 'default';
	window.setTimeout('$(\'close_layer_regulaciones' + seg + '\').focus()', 1200);
	if (src)
		{
		cache_regulaciones[src] = $('layer_regulaciones_content' + seg).innerHTML;
		}
	regulaciones_on[seg] = true;
	}

function show_comparativa_familias(tipo_ruta, diccionario)
	{
	if ($('comparativa_familias') && typeof(Dynamic_Components) != 'undefined')
		{
		$('comparativa_familias').style.display = 'block';

		var offset_y = (document.documentElement.scrollTop ? document.documentElement.scrollTop : document.body.scrollTop) + 10;
		$('comparativa_familias').style.top = offset_y + 'px';

		if (!window.comparativa_familias_loading)
			{
			window.comparativa_familias_loading = $('comparativa_familias_content').innerHTML;
			}

		if (!window.comparativa_familias_loaded)
			{
			$('comparativa_familias_content').innerHTML = window.comparativa_familias_loading;

			window.comparativa_familias_loaded = 1;
			Dynamic_Components.refresh_component(
				'comparativa_familias_content',
				'102',
				"tipo_ruta='" + tipo_ruta + "',diccionario='" + diccionario + "'",
				null,
				function ()
					{
					window.comparativa_familias_loaded = 0;
					}
				);
			}
		}
	}
function hide_comparativa_familias()
	{
	if ($('comparativa_familias'))
		{
		$('comparativa_familias').style.display = 'none';
		}
	}

function show_popup(id)
	{
	if ($('popup'+id) && typeof(Dynamic_Components) != 'undefined')
		{
		$('popup'+id).style.display = 'block';

		var offset_y = (document.documentElement.scrollTop ? document.documentElement.scrollTop : document.body.scrollTop) + 10;
		$('popup'+id).style.top = offset_y + 'px';
		}
	}
function hide_popup(id)
	{
	if ($('popup'+id))
		{
		$('popup'+id).style.display = 'none';
		}
	}

function activa_flight_info(operado_por, marketeado_por, id_class, flight_stats_query) {
	if (flight_stats_query != '') {
		activa_flight_info_anac(operado_por, marketeado_por, id_class, flight_stats_query);
		return;
	}
	if (operado_por == '' || marketeado_por == '')
		return;

	var obj = $(divName);
	obj.innerHTML = document.getElementById("ttip_flight_info").innerHTML;
	document.getElementById("div_flight_info").innerHTML = '{_LABEL_OPERADO_POR_INI} ' + operado_por + ' {_LABEL_OPERADO_POR_FIN} {_PALABRA_Y} {_LABEL_MARKETEADO_POR_INI} ' + marketeado_por + ' {_LABEL_MARKETEADO_POR_FIN}';
	obj.className = id_class;
	document.onmousemove = follow;
	
}

function desactiva_flight_info()
	{
	var obj = $(divName);
	obj.style.visibility = 'hidden';
	document.onmousemove = '';
	}

function getFee(fare, q, moneda) {
	var feeData = jQuery.data(document.body, 'feeChargeData');
	var fee;
	var precio_total = fare;
	if (feeOverFareQ) {
		precio_total += q;
	}
	if (feeData.tipo_config === 'rango') {
		for (var i in feeData.fee_range_config) {
			if (feeData.fee_range_config[i].rango_inferior < precio_total && (typeof feeData.fee_range_config[i].rango_superior === 'undefined' || feeData.fee_range_config[i].rango_superior >= precio_total || feeData.fee_range_config[i].rango_superior === '0.00')) {
				fee = parseFloat(feeData.fee_range_config[i].monto_fee) + parseFloat(feeData.fee_range_config[i].monto_fee * feeData.impuesto_monto_fee/100);
				return parseFloat(currencyRound(fee, moneda));
			}
		}
	}
	else if (feeData.tipo_config === 'porcentaje') {
		fee = feeData.fee_percent_config.porcentaje/100 * precio_total;
		if (fee < feeData.fee_percent_config.monto_fee_minimo) {
			fee = parseFloat(feeData.fee_percent_config.monto_fee_minimo);
		}
		fee += parseFloat(fee * feeData.impuesto_monto_fee/100);
		return parseFloat(currencyRound(fee, moneda));
	}

	return 0;
}
</script>
{+TEMPLATE('/componentes/compra/tooltip.tpl')}
